<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§ç‰©æµç®¡ç†ç³»ç»Ÿ - ç»¼åˆç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-tabs .nav-link.active { background-color: #e9ecef; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1 class="text-primary fw-bold">ğŸ“¦ æ™ºæ…§ç‰©æµç®¡ç†ç³»ç»Ÿ</h1>
        <p class="text-muted">é›†æˆå®éªŒä¸€ & å®éªŒäºŒ</p>
    </div>

    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="exp1-tab" data-bs-toggle="tab" data-bs-target="#exp1">å®éªŒä¸€ï¼šç‰©æµè®¡ç®—</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="exp2-tab" data-bs-toggle="tab" data-bs-target="#exp2">å®éªŒäºŒï¼šæ•°æ®ç®¡ç†(æ–‡ä»¶é”)</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="exp3-tab" data-bs-toggle="tab" data-bs-target="#exp3">å®éªŒä¸‰ï¼šSQLè§£æå™¨</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="exp1" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">å½“å‰åœ°åŒº</label>
                            <select id="regionSelect" class="form-select" onchange="loadGoods()"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ç‰©æµæ–¹æ¡ˆ</label>
                            <select id="schemeSelect" class="form-select" onchange="loadGoods()">
                                <option value="1">æ–¹æ¡ˆ1: ä»·æ ¼æœ€å°</option>
                                <option value="2">æ–¹æ¡ˆ2: æ—¶é—´æœ€çŸ­</option>
                                <option value="3">æ–¹æ¡ˆ3: ç»¼åˆæœ€ä¼˜</option>
                                <option value="4">æ–¹æ¡ˆ4: èˆªç©ºç‰©æµ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">æ“ä½œ</label>
                            <div class="d-grid gap-2"><button class="btn btn-primary" onclick="loadGoods()">ğŸ”„ åˆ·æ–°</button></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead><tr><th>ID</th><th>åç§°</th><th>æ‰€å±åœ°</th><th>å‘å¾€åœ°</th><th>ä¼˜å…ˆçº§</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="goodsTableBody"></tbody>
                    </table>
                </div>
            </div>
             <div class="card mt-3">
                <div class="card-body">
                    <div class="input-group">
                        <span class="input-group-text">å‘å¾€åœ°</span>
                        <select id="targetRegionSelect" class="form-select"></select>
                        <button class="btn btn-info" onclick="calculatePath()">è®¡ç®—è·¯å¾„</button>
                    </div>
                    <div id="pathResult" class="mt-2 p-2 bg-dark text-white rounded">ç­‰å¾…è®¡ç®—...</div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="exp2" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">ğŸ“‚ è¡¨ç®¡ç†</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label>æ–°å»ºæ•°æ®è¡¨</label>
                                <div class="input-group mb-2">
                                    <input type="text" id="newTableName" class="form-control" placeholder="è¡¨å(å¦‚user)">
                                    <input type="text" id="newTableCols" class="form-control" placeholder="åˆ—å(å¦‚id,name,role)">
                                </div>
                                <button class="btn btn-sm btn-success w-100" onclick="createTable()">æ–°å»ºè¡¨</button>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label>é€‰æ‹©æ“ä½œè¡¨</label>
                                <select id="dbTableSelect" class="form-select" onchange="resetAndLoad()">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>æ’å…¥è®°å½• (é€—å·åˆ†éš”)</label>
                                <input type="text" id="insertData" class="form-control" placeholder="å¯¹åº”åˆ—çš„å€¼">
                                <button class="btn btn-sm btn-warning w-100 mt-2" onclick="insertRecord()">å†™å…¥ (äº’æ–¥é”)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ” æ•°æ®æŸ¥è¯¢ (å…±äº«é”)</span>
                            <div class="input-group w-75"> <select id="searchColSelect" class="form-select form-select-sm" style="max-width: 150px;">
                                    <option value="-1">å…¨éƒ¨åˆ—</option>
                                </select>
                                <input type="text" id="searchKey" class="form-control form-control-sm" placeholder="å…³é”®å­—...">
                                <button class="btn btn-sm btn-secondary" onclick="loadTableData(true)">æŸ¥è¯¢</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="tableContainer" style="overflow-x:auto;">
                                <p class="text-center p-3 text-muted">è¯·é€‰æ‹©è¡¨è¿›è¡ŒæŸ¥çœ‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="exp3" role="tabpanel">
            <div class="card">
                <div class="card-header bg-dark text-white">ğŸ’» SQL äº¤äº’æ§åˆ¶å°</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">è¯·è¾“å…¥ SQL è¯­å¥ (æ”¯æŒ SELECT, INSERT, CREATE TABLE, DELETE, UPDATE)</label>
                        <textarea id="sqlInput" class="form-control" rows="4" style="font-family: monospace; background: #f8f9fa;" placeholder="ä¾‹å¦‚ï¼š
        CREATE TABLE teacher (id, name, course);
        INSERT INTO teacher VALUES (1, MrWang, Math);
        SELECT * FROM teacher WHERE name = MrWang;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="runSQL()">â–¶ æ‰§è¡Œè§£æ (Run)</button>
                    <button class="btn btn-outline-secondary" onclick="document.getElementById('sqlInput').value=''">æ¸…ç©º</button>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">æ‰§è¡Œç»“æœ</div>
                <div class="card-body">
                    <div id="sqlResult" class="p-3 bg-light border rounded" style="min-height: 100px;">
                        <span class="text-muted">ç­‰å¾…æ‰§è¡Œ...</span>
                    </div>
                    <div id="sqlTableContainer" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // åŠ è½½å®éªŒä¸€æ•°æ®
        await loadRegions(); loadGoods();
        // åŠ è½½å®éªŒäºŒæ•°æ®
        loadTableList(); 
    });
    
    // --- å®éªŒä¸€å‡½æ•° ---
    async function loadRegions() {
        const res = await fetch('/api/regions');
        const regions = await res.json();
        const rSelect = document.getElementById('regionSelect');
        const tSelect = document.getElementById('targetRegionSelect');
        rSelect.innerHTML = '<option value="ALL">== æŸ¥çœ‹å…¨éƒ¨åœ°åŒº ==</option>';
        tSelect.innerHTML = '';
        regions.forEach(r => {
            rSelect.add(new Option(r, r));
            tSelect.add(new Option(r, r));
        });
    }
    async function loadGoods() {
        const r = document.getElementById('regionSelect').value;
        const s = document.getElementById('schemeSelect').value;
        const res = await fetch(`/api/goods?region=${encodeURIComponent(r)}&scheme=${s}`);
        const goods = await res.json();
        document.getElementById('goodsTableBody').innerHTML = goods.map(g => `<tr><td>${g.id}</td><td>${g.name}</td><td>${g.belongingArea}</td><td>${g.sendingArea}</td><td>${g.priority}</td><td><button class="btn btn-sm btn-success" onclick="shipGoods(${g.id})">å‘è´§</button></td></tr>`).join('');
    }
    async function shipGoods(id) { fetch(`/api/ship?id=${id}&scheme=${document.getElementById('schemeSelect').value}`).then(()=>loadGoods()); }
    async function calculatePath() { 
        const s = document.getElementById('regionSelect').value; 
        const e = document.getElementById('targetRegionSelect').value;
        const res = await fetch(`/api/path?start=${s}&end=${e}&scheme=${document.getElementById('schemeSelect').value}`);
        const d = await res.json();
        document.getElementById('pathResult').innerText = d.result;
    }

    // --- å®éªŒäºŒå‡½æ•° ---
    async function loadTableList() {
        const res = await fetch('/api/db/list');
        const tables = await res.json();
        const sel = document.getElementById('dbTableSelect');
        sel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
        tables.forEach(t => sel.add(new Option(t, t)));
    }
    async function createTable() {
        const name = document.getElementById('newTableName').value;
        const cols = document.getElementById('newTableCols').value;
        if(!name || !cols) return alert("è¯·è¾“å…¥è¡¨åå’Œåˆ—å");
        const res = await fetch(`/api/db/create?name=${name}&cols=${cols}`);
        const d = await res.json();
        if(d.success) { alert('åˆ›å»ºæˆåŠŸ'); loadTableList(); } else alert('åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½è¡¨å·²å­˜åœ¨');
    }
    async function insertRecord() {
        const table = document.getElementById('dbTableSelect').value;
        const data = document.getElementById('insertData').value;
        if(!table || !data) return alert("è¯·é€‰æ‹©è¡¨å¹¶è¾“å…¥æ•°æ®");
        const res = await fetch(`/api/db/insert?table=${table}&data=${encodeURIComponent(data)}`);
        const d = await res.json();
        if(d.success) { alert('å†™å…¥æˆåŠŸ'); loadTableData(); } else alert('å†™å…¥å¤±è´¥ (å¯èƒ½è¢«é”é˜»å¡)');
    }
    async function loadTableData(isQueryClick = false) {    
        const table = document.getElementById('dbTableSelect').value;
        const key = document.getElementById('searchKey').value;
        const colSelect = document.getElementById('searchColSelect');
        // è·å–å½“å‰é€‰ä¸­çš„åˆ—ç´¢å¼•ï¼Œå¦‚æœæ˜¯åˆæ¬¡åŠ è½½åˆ™ä¸º -1
        let colIdx = colSelect.value || -1;

        if(!table) return;

        // å‘é€è¯·æ±‚
        const res = await fetch(`/api/db/query?table=${table}&key=${encodeURIComponent(key)}&colIdx=${colIdx}`);
        const rows = await res.json();
        
        const container = document.getElementById('tableContainer');
        if(rows.length === 0) { 
            container.innerHTML = '<p class="text-center p-3">æ— æ•°æ®</p>'; 
            return; 
        }

        // --- [æ–°å¢é€»è¾‘] åŠ¨æ€æ›´æ–°â€œæœç´¢åˆ—â€ä¸‹æ‹‰æ¡† ---
        // åªæœ‰å½“ä¸æ˜¯ç‚¹å‡»â€œæŸ¥è¯¢â€æŒ‰é’®è§¦å‘çš„ï¼ˆå³åˆ‡æ¢è¡¨æ—¶ï¼‰ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œæ‰æ›´æ–°ä¸‹æ‹‰æ¡†
        // è¿™æ ·å¯ä»¥é¿å…ç”¨æˆ·é€‰äº†â€œNameâ€åˆ—ï¼Œä¸€ç‚¹æŸ¥è¯¢ï¼Œä¸‹æ‹‰æ¡†åˆé‡ç½®å›â€œå…¨éƒ¨åˆ—â€äº†
        if (!isQueryClick) {
            const cols = Object.keys(rows[0]); // è·å–è¡¨å¤´
            colSelect.innerHTML = '<option value="-1">å…¨éƒ¨åˆ—</option>';
            cols.forEach((c, index) => {
                colSelect.add(new Option(c, index)); // value æ˜¯ç´¢å¼• 0, 1, 2...
            });
        }
        // ---------------------------------------

        // æ¸²æŸ“è¡¨æ ¼
        const cols = Object.keys(rows[0]);
        let html = '<table class="table table-bordered table-sm mb-0"><thead><tr>';
        cols.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        rows.forEach(r => {
            html += '<tr>';
            cols.forEach(c => html += `<td>${r[c]}</td>`);
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    function resetAndLoad() {
        // åˆ‡æ¢è¡¨æ—¶ï¼Œæ¸…ç©ºæœç´¢æ¡†å’Œåˆ—é€‰æ‹©
        document.getElementById('searchKey').value = '';
        document.getElementById('searchColSelect').innerHTML = '<option value="-1">å…¨éƒ¨åˆ—</option>';
        loadTableData(false);
    }

    // --- å®éªŒä¸‰ JS ---
    async function runSQL() {
        const sqlRaw = document.getElementById('sqlInput').value.trim();
        if(!sqlRaw) return;

        // æ”¯æŒå¤šæ¡è¯­å¥ä»¥åˆ†å·åˆ†éš” (ç®€å•å®ç°ï¼šå¾ªç¯å‘é€)
        const sqls = sqlRaw.split(';').filter(s => s.trim().length > 0);
        
        const resDiv = document.getElementById('sqlResult');
        const tableDiv = document.getElementById('sqlTableContainer');
        resDiv.innerHTML = '';
        tableDiv.innerHTML = '';

        for (let sql of sqls) {
            sql = sql.trim();
            resDiv.innerHTML += `<div><strong>> ${sql}</strong></div>`;
            
            try {
                const res = await fetch(`/api/sql/execute?q=${encodeURIComponent(sql)}`);
                const d = await res.json();
                
                if(d.success) {
                    resDiv.innerHTML += `<div class="text-success">âœ… ${d.msg || 'Success'}</div>`;
                    if(d.data) {
                        renderSqlTable(d.data);
                    }
                } else {
                    resDiv.innerHTML += `<div class="text-danger">âŒ ${d.msg}</div>`;
                }
            } catch(e) {
                resDiv.innerHTML += `<div class="text-danger">âŒ ç½‘ç»œæˆ–è§£æé”™è¯¯</div>`;
            }
            resDiv.innerHTML += `<hr>`;
        }
    }

    function renderSqlTable(rows) {
        if(!rows || rows.length === 0) return;
        const cols = Object.keys(rows[0]);
        let html = '<table class="table table-bordered table-sm table-hover"><thead><tr>';
        cols.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        rows.forEach(r => {
            html += '<tr>';
            cols.forEach(c => html += `<td>${r[c]}</td>`);
            html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('sqlTableContainer').innerHTML = html;
    }
</script>
</body>
</html>