<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§ç‰©æµç®¡ç†ç³»ç»Ÿ - æ——èˆ°ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-tabs .nav-link.active { background-color: #e9ecef; font-weight: bold; border-bottom: 3px solid #0d6efd; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1 class="text-primary fw-bold">ğŸ“¦ äº’è”ç½‘+ æ™ºæ…§ç‰©æµè´¨è¯¢ç³»ç»Ÿ</h1>
        <p class="text-muted">é›†æˆå®éªŒ 1-4</p>
    </div>

    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="exp4-tab" data-bs-toggle="tab" data-bs-target="#exp4">ğŸš€ å®éªŒå››ï¼šç»¼åˆé›†æˆå¹³å°</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="exp1-tab" data-bs-toggle="tab" data-bs-target="#exp1">å®éªŒä¸€ï¼šç‰©æµè®¡ç®—</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="exp2-tab" data-bs-toggle="tab" data-bs-target="#exp2">å®éªŒäºŒï¼šæ•°æ®ä¸€è‡´æ€§</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="exp3-tab" data-bs-toggle="tab" data-bs-target="#exp3">å®éªŒä¸‰ï¼šSQLè§£æ</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="exp4" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">âš™ï¸ æ ¸å¿ƒæ•°æ®ç®¡æ§</div>
                        <div class="card-body">
                            <p class="small text-muted">é€šè¿‡ SQL ç›´æ¥ä¿®æ”¹åº•å±‚æ•°æ®(ç‰©å“/èŠ‚ç‚¹)ï¼Œå½±å“ç‰©æµè®¡ç®—ç»“æœã€‚</p>
    
                            <div class="mb-2">
                                <label class="form-label fw-bold small">å¸¸ç”¨èŠ‚ç‚¹æ“ä½œ SQL æ¨¡æ¿:</label><br>
                                <button class="btn btn-xs btn-outline-secondary me-1" onclick="setSql('SELECT * FROM regionPrice;')">æŸ¥çœ‹ä»·æ ¼çŸ©é˜µ</button>
                                <button class="btn btn-xs btn-outline-secondary me-1" onclick="setSql('UPDATE regionPrice SET Guangzhou=999 WHERE StartNode=Beijing;')">ä¿®æ”¹èŠ‚ç‚¹è¿è´¹</button>
                                <button class="btn btn-xs btn-outline-secondary" onclick="setSql('CREATE TABLE nodeInfo (id,name,type); INSERT INTO nodeInfo VALUES (1,Beijing,Hub);')">æ–°å»ºèŠ‚ç‚¹è¡¨</button>
                            </div>

                            <label>SQL æŒ‡ä»¤ (æ”¯æŒ INSERT, UPDATE, DELETE):</label>
                            <textarea id="sysSqlInput" class="form-control mb-2" rows="3" placeholder="åœ¨æ­¤è¾“å…¥ SQL..."></textarea>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-warning flex-grow-1" onclick="runSysSQL()">æ‰§è¡Œ SQL å¹¶ä¿®æ”¹åº•å±‚æ–‡ä»¶</button>
                                <button class="btn btn-danger" onclick="reloadSystem()">ğŸ”„ é‡è½½ç³»ç»Ÿå†…å­˜</button>
                            </div>
                            <div id="sysSqlResult" class="mt-2 text-muted small"></div>
                            
                            <div id="sysSqlTable" class="mt-2 table-responsive"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">ğŸ“Š ç‰©æµçŠ¶æ€æŸ¥è¯¢ (Trace)</div>
                        <div class="card-body">
                            <div class="input-group mb-3">
                                <input type="text" id="traceInput" class="form-control" placeholder="è¾“å…¥è´§ç‰© ID æˆ– åç§°">
                                <button class="btn btn-info" onclick="traceGoods()">ğŸ” è´¨è¯¢</button>
                            </div>
                            <div id="traceResult">
                                <div class="alert alert-secondary text-center">è¯·è¾“å…¥æŸ¥è¯¢æ¡ä»¶</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">ğŸ“¡ å®æ—¶ç‰©æµç›‘æ§</div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>å½“å‰è´§ç‰©åˆ—è¡¨</h5>
                                <button class="btn btn-sm btn-outline-success" onclick="loadMonitor()">åˆ·æ–°ç›‘æ§</button>
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-hover">
                                    <thead><tr><th>ID</th><th>åç§°</th><th>æ–¹æ¡ˆ</th><th>ä¼˜å…ˆçº§</th></tr></thead>
                                    <tbody id="monitorBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="exp1" role="tabpanel">
            <div class="card"><div class="card-body"><div class="row g-3">
                <div class="col-md-4"><label>å½“å‰åœ°åŒº</label><select id="regionSelect" class="form-select" onchange="loadGoods()"></select></div>
                <div class="col-md-4"><label>ç‰©æµæ–¹æ¡ˆ</label><select id="schemeSelect" class="form-select" onchange="loadGoods()">
                    <option value="1">æ–¹æ¡ˆ1: ä»·æ ¼æœ€å°</option><option value="2">æ–¹æ¡ˆ2: æ—¶é—´æœ€çŸ­</option><option value="3">æ–¹æ¡ˆ3: ç»¼åˆæœ€ä¼˜</option><option value="4">æ–¹æ¡ˆ4: èˆªç©ºç‰©æµ</option>
                </select></div>
                <div class="col-md-4"><label>æ“ä½œ</label><div class="d-grid"><button class="btn btn-primary" onclick="loadGoods()">ğŸ”„ åˆ·æ–°</button></div></div>
            </div></div></div>
            <div class="card"><div class="card-body p-0"><table class="table table-striped mb-0">
                <thead><tr><th>ID</th><th>åç§°</th><th>æ‰€å±åœ°</th><th>å‘å¾€åœ°</th><th>ä¼˜å…ˆçº§</th><th>æ“ä½œ</th></tr></thead><tbody id="goodsTableBody"></tbody>
            </table></div></div>
             <div class="card mt-3"><div class="card-body"><div class="input-group">
                <span class="input-group-text">å‘å¾€åœ°</span><select id="targetRegionSelect" class="form-select"></select><button class="btn btn-info" onclick="calculatePath()">è®¡ç®—è·¯å¾„</button>
            </div><div id="pathResult" class="mt-2 p-2 bg-dark text-white rounded">ç­‰å¾…è®¡ç®—...</div></div></div>
        </div>

        <div class="tab-pane fade" id="exp2" role="tabpanel">
            <div class="row"><div class="col-md-4"><div class="card"><div class="card-header">ğŸ“‚ è¡¨ç®¡ç†</div><div class="card-body">
                <div class="mb-3"><label>æ–°å»ºæ•°æ®è¡¨</label><div class="input-group mb-2"><input type="text" id="newTableName" class="form-control" placeholder="è¡¨å"><input type="text" id="newTableCols" class="form-control" placeholder="åˆ—å"></div><button class="btn btn-sm btn-success w-100" onclick="createTable()">æ–°å»ºè¡¨</button></div><hr>
                <div class="mb-3"><label>é€‰æ‹©æ“ä½œè¡¨</label><select id="dbTableSelect" class="form-select" onchange="resetAndLoad()"><option value="">-- è¯·é€‰æ‹© --</option></select></div>
                <div class="mb-3"><label>æ’å…¥è®°å½•</label><input type="text" id="insertData" class="form-control" placeholder="å€¼"><button class="btn btn-sm btn-warning w-100 mt-2" onclick="insertRecord()">å†™å…¥ (äº’æ–¥é”)</button></div>
            </div></div></div>
            <div class="col-md-8"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>ğŸ” æ•°æ®æŸ¥è¯¢ (å…±äº«é”)</span>
                <div class="input-group w-75"><select id="searchColSelect" class="form-select form-select-sm" style="max-width:150px;"><option value="-1">å…¨éƒ¨åˆ—</option></select><input type="text" id="searchKey" class="form-control form-control-sm" placeholder="å…³é”®å­—..."><button class="btn btn-sm btn-secondary" onclick="loadTableData(true)">æŸ¥è¯¢</button></div>
            </div><div class="card-body p-0"><div id="tableContainer" style="overflow-x:auto;"></div></div></div></div></div>
        </div>

        <div class="tab-pane fade" id="exp3" role="tabpanel">
            <div class="card"><div class="card-header bg-dark text-white">ğŸ’» SQL äº¤äº’æ§åˆ¶å°</div><div class="card-body">
                <div class="mb-3"><textarea id="sqlInput" class="form-control" rows="4" style="font-family:monospace;background:#f8f9fa;" placeholder="SELECT * FROM goodsInfo;"></textarea></div>
                <button class="btn btn-primary" onclick="runSQL()">â–¶ æ‰§è¡Œè§£æ</button>
            </div></div>
            <div class="card mt-3"><div class="card-header">æ‰§è¡Œç»“æœ</div><div class="card-body"><div id="sqlResult" class="p-3 bg-light border rounded"></div><div id="sqlTableContainer" class="mt-3"></div></div></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        await loadRegions(); loadGoods(); loadTableList(); loadMonitor();
    });

    // --- Exp 4 Functions ---
    async function runSysSQL() {
        const sql = document.getElementById('sysSqlInput').value.trim();
        if(!sql) return;
        const res = await fetch(`/api/sql/execute?q=${encodeURIComponent(sql)}`);
        const d = await res.json();
        const div = document.getElementById('sysSqlResult');
        div.innerHTML = d.success ? `<span class="text-success">âœ… ${d.msg}</span>` : `<span class="text-danger">âŒ ${d.msg}</span>`;
        if(d.success) {
            // å¦‚æœä¿®æ”¹äº† goodsInfoï¼Œå»ºè®®æç¤ºç”¨æˆ·é‡è½½
            if(sql.toLowerCase().includes('goodsinfo')) {
                div.innerHTML += ` <span class="badge bg-warning text-dark">æ£€æµ‹åˆ°è´§ç‰©å˜åŠ¨ï¼Œå»ºè®®ç‚¹å‡»é‡è½½</span>`;
            }
        }
    }

    async function reloadSystem() {
        const res = await fetch('/api/reload');
        const d = await res.json();
        alert(d.msg);
        loadMonitor(); // åˆ·æ–°ç›‘æ§
        loadGoods(); // åˆ·æ–°Exp1åˆ—è¡¨
    }

    async function traceGoods() {
        const q = document.getElementById('traceInput').value;
        if(!q) return;
        const res = await fetch(`/api/status?q=${encodeURIComponent(q)}`);
        const d = await res.json();
        const div = document.getElementById('traceResult');
        
        if(d.found) {
            div.innerHTML = `
                <div class="card border-info">
                    <div class="card-body">
                        <h5 class="card-title text-info">ğŸ“¦ ${d.name} (ID: ${d.id})</h5>
                        <p class="card-text">
                            <strong>å½“å‰çŠ¶æ€:</strong> <span class="badge bg-success">${d.status}</span><br>
                            <strong>ç‰©æµæ–¹æ¡ˆ:</strong> æ–¹æ¡ˆ ${d.scheme}<br>
                            <strong>å½“å‰ä¼˜å…ˆçº§:</strong> ${d.priority}<br>
                        </p>
                        <div class="bg-dark text-white p-2 rounded small" style="white-space: pre-wrap;">${d.currentPath}</div>
                    </div>
                </div>
            `;
        } else {
            div.innerHTML = `<div class="alert alert-warning">${d.msg}</div>`;
        }
    }

    async function loadMonitor() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        // ç®€å•å–æ‰€æœ‰æ–¹æ¡ˆçš„å‰å‡ ä¸ªæ•°æ®åšå±•ç¤º
        for(let s=1; s<=4; ++s) {
            const res = await fetch(`/api/goods?scheme=${s}&region=ALL`);
            const goods = await res.json();
            goods.forEach(g => {
                tbody.innerHTML += `<tr><td>${g.id}</td><td>${g.name}</td><td>${s}</td><td>${g.priority}</td></tr>`;
            });
        }
    }

    // --- Exp 1, 2, 3 Functions (Keep existing logic) ---
    async function loadRegions() {
        const res = await fetch('/api/regions');
        const regions = await res.json();
        const rSelect = document.getElementById('regionSelect');
        const tSelect = document.getElementById('targetRegionSelect');
        rSelect.innerHTML = '<option value="ALL">== æŸ¥çœ‹å…¨éƒ¨åœ°åŒº ==</option>';
        tSelect.innerHTML = '';
        regions.forEach(r => {
            rSelect.add(new Option(r, r));
            tSelect.add(new Option(r, r));
        });
    }
    async function loadGoods() {
        const r = document.getElementById('regionSelect').value;
        const s = document.getElementById('schemeSelect').value;
        const res = await fetch(`/api/goods?region=${encodeURIComponent(r)}&scheme=${s}`);
        const goods = await res.json();
        document.getElementById('goodsTableBody').innerHTML = goods.map(g => `<tr><td>${g.id}</td><td>${g.name}</td><td>${g.belongingArea}</td><td>${g.sendingArea}</td><td>${g.priority}</td><td><button class="btn btn-sm btn-success" onclick="shipGoods(${g.id})">å‘è´§</button></td></tr>`).join('');
    }
    async function shipGoods(id) { fetch(`/api/ship?id=${id}&scheme=${document.getElementById('schemeSelect').value}`).then(()=>loadGoods()); }
    async function calculatePath() { 
        const s = document.getElementById('regionSelect').value; 
        const e = document.getElementById('targetRegionSelect').value;
        const res = await fetch(`/api/path?start=${s}&end=${e}&scheme=${document.getElementById('schemeSelect').value}`);
        const d = await res.json();
        document.getElementById('pathResult').innerText = d.result;
    }
    // Exp 2
    async function loadTableList() { const res = await fetch('/api/db/list'); const tables = await res.json(); const sel = document.getElementById('dbTableSelect'); sel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>'; tables.forEach(t => sel.add(new Option(t, t))); }
    async function createTable() { const n = document.getElementById('newTableName').value; const c = document.getElementById('newTableCols').value; const r = await fetch(`/api/db/create?name=${n}&cols=${c}`); const d = await res.json(); if(d.success) {alert('æˆåŠŸ');loadTableList();} }
    async function insertRecord() { const t = document.getElementById('dbTableSelect').value; const v = document.getElementById('insertData').value; const r = await fetch(`/api/db/insert?table=${t}&data=${v}`); const d = await r.json(); alert(d.success?'æˆåŠŸ':'å¤±è´¥'); if(d.success) loadTableData(); }
    async function resetAndLoad() { document.getElementById('searchKey').value=''; document.getElementById('searchColSelect').innerHTML='<option value="-1">å…¨éƒ¨åˆ—</option>'; loadTableData(false); }
    async function loadTableData(isClick=false) {
        const t = document.getElementById('dbTableSelect').value; if(!t) return;
        const k = document.getElementById('searchKey').value;
        const col = document.getElementById('searchColSelect').value || -1;
        const res = await fetch(`/api/db/query?table=${t}&key=${k}&colIdx=${col}`);
        const rows = await res.json();
        const con = document.getElementById('tableContainer');
        if(!rows.length) { con.innerHTML='<p class="text-center p-3">æ— æ•°æ®</p>'; return; }
        if(!isClick) {
            const cs = document.getElementById('searchColSelect'); cs.innerHTML='<option value="-1">å…¨éƒ¨åˆ—</option>';
            Object.keys(rows[0]).forEach((c,i)=>cs.add(new Option(c,i)));
        }
        let h = '<table class="table table-bordered table-sm"><thead><tr>'+Object.keys(rows[0]).map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
        rows.forEach(r=>{h+='<tr>'+Object.values(r).map(v=>`<td>${v}</td>`).join('')+'</tr>'});
        con.innerHTML = h+'</tbody></table>';
    }
    // Exp 3
    async function runSQL() {
        const raw = document.getElementById('sqlInput').value.trim();
        if(!raw) return;
        const sqls = raw.split(';').filter(s=>s.trim().length>0);
        const rd = document.getElementById('sqlResult'); const td = document.getElementById('sqlTableContainer');
        rd.innerHTML=''; td.innerHTML='';
        for(let s of sqls) {
            rd.innerHTML += `<div>> ${s}</div>`;
            const r = await fetch(`/api/sql/execute?q=${encodeURIComponent(s)}`);
            const d = await r.json();
            rd.innerHTML += d.success ? `<div class="text-success">âœ… ${d.msg}</div>` : `<div class="text-danger">âŒ ${d.msg}</div>`;
            if(d.data && d.data.length) {
                let h = '<table class="table table-bordered table-sm"><thead><tr>'+Object.keys(d.data[0]).map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
                d.data.forEach(r=>{h+='<tr>'+Object.values(r).map(v=>`<td>${v}</td>`).join('')+'</tr>'});
                td.innerHTML = h+'</tbody></table>';
            }
            rd.innerHTML += '<hr>';
        }
    }

    function setSql(sql) {
        document.getElementById('sysSqlInput').value = sql;
    }

    async function runSysSQL() {
        const sql = document.getElementById('sysSqlInput').value.trim();
        if(!sql) return;
        const res = await fetch(`/api/sql/execute?q=${encodeURIComponent(sql)}`);
        const d = await res.json();
        const div = document.getElementById('sysSqlResult');
        const tbl = document.getElementById('sysSqlTable');
        
        div.innerHTML = d.success ? `<span class="text-success">âœ… ${d.msg}</span>` : `<span class="text-danger">âŒ ${d.msg}</span>`;
        
        // [æ–°å¢] å¦‚æœæœ‰è¿”å›æ•°æ®ï¼ˆSELECTï¼‰ï¼Œæ˜¾ç¤ºè¡¨æ ¼
        tbl.innerHTML = '';
        if(d.data && d.data.length > 0) {
            let h = '<table class="table table-bordered table-sm table-striped" style="font-size:0.8em"><thead><tr>'+Object.keys(d.data[0]).map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
            d.data.forEach(r=>{h+='<tr>'+Object.values(r).map(v=>`<td>${v}</td>`).join('')+'</tr>'});
            tbl.innerHTML = h+'</tbody></table>';
        }

        if(d.success && (sql.toLowerCase().includes('update') || sql.toLowerCase().includes('insert') || sql.toLowerCase().includes('delete'))) {
            div.innerHTML += ` <span class="badge bg-warning text-dark">æ•°æ®å·²å˜æ›´ï¼Œè¯·ç‚¹å‡»é‡è½½</span>`;
        }
    }
</script>
</body>
</html>